<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuit AI Speaking Level Test</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1', // Indigo-500
                        primaryDark: '#4F46E5', // Indigo-600
                        primaryLight: '#E0E7FF', // Indigo-100
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Nunito', 'Noto Sans KR', sans-serif; background-color: #F3F4F6; }
        
        /* Animations */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            animation: pulse-ring 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .gauge-bg { background-color: #E2E8F0; border-radius: 999px; height: 12px; overflow: hidden; }
        .gauge-bar { height: 100%; border-radius: 999px; width: 0%; transition: width 1.5s ease-out 0.5s; }
        
        /* Scrollbar Customization */
        #messages::-webkit-scrollbar { width: 6px; }
        #messages::-webkit-scrollbar-track { background: #f1f1f1; }
        #messages::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800 bg-slate-50">

    <!-- 1. Landing Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border-4 border-primaryLight relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-primaryLight rounded-full -mr-16 -mt-16 opacity-50"></div>
            
            <div class="relative z-10 text-center">
                <div class="w-16 h-16 bg-primaryLight text-primary rounded-full flex items-center justify-center mx-auto mb-4 text-3xl shadow-sm">ğŸ¤–</div>
                
                <h2 class="text-2xl font-extrabold text-slate-800 mb-6">Tuit AI Speaking Level Test</h2>
                
                <div class="bg-slate-50 rounded-xl p-5 mb-6 text-left border border-slate-100">
                    <h3 class="font-bold text-slate-700 mb-3 flex items-center">
                        <span class="text-xl mr-2">ğŸ“‹</span> í…ŒìŠ¤íŠ¸ ì•ˆë‚´
                    </h3>
                    <ul class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start"><i class="fas fa-check text-primary mt-1 mr-2 text-xs"></i><span>íŠœì‡ê³¼ ì•½ 5ë¶„ê°„ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¥¼ ë‚˜ëˆ ìš”.</span></li>
                        <li class="flex items-start"><i class="fas fa-check text-primary mt-1 mr-2 text-xs"></i><span>CEFR(ìœ ëŸ½ê³µí†µì–¸ì–´í‰ê°€)ê¸°ì¤€ ë‚´ ìŠ¤í”¼í‚¹ ë ˆë²¨ì„ ì •í™•íˆ ì¸¡ì •í•´ìš”.</span></li>
                        <li class="flex items-start"><i class="fas fa-check text-primary mt-1 mr-2 text-xs"></i><span>ë§ì¶¤ êµì¬ì™€ ë¬´ë£Œ ì²´í—˜ ìˆ˜ì—…ì„ ì¶”ì²œí•´ë“œë ¤ìš”.</span></li>
                    </ul>
                </div>

                <div class="space-y-3" id="setupControls">
                    <!-- Injected via JS -->
                </div>
                <p class="text-[10px] text-slate-400 mt-4" id="setupFooter" style="display:none;">* í‚¤ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šê³  ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- 2. Chat Interface -->
    <div id="chatInterface" class="hidden flex-1 flex flex-col max-w-lg mx-auto w-full bg-white shadow-2xl relative h-full">
        <div class="bg-white/95 backdrop-blur-md p-4 flex items-center justify-between border-b border-slate-100 z-10 absolute top-0 w-full shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white text-lg shadow-md font-bold">T</div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm">Tuit AI Teacher</h1>
                    <div class="flex items-center text-xs text-primary font-semibold">
                        <span class="w-2 h-2 bg-primary rounded-full mr-1 animate-pulse"></span> Online
                    </div>
                </div>
            </div>
            <button onclick="endTestEarly()" class="text-xs text-slate-400 hover:text-red-500 font-bold px-3 py-1 border border-slate-200 rounded-full transition">
                ì¢…ë£Œí•˜ê¸°
            </button>
        </div>

        <!-- Messages Area -->
        <div id="messages" class="flex-1 overflow-y-auto p-5 pt-24 pb-48 space-y-6 bg-slate-50 scroll-smooth"></div>

        <!-- Controls Area -->
        <div class="absolute bottom-0 w-full bg-white p-6 rounded-t-[2rem] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-20 border-t border-slate-50">
            <div id="statusText" class="text-center text-xs font-bold text-slate-400 mb-4 h-4 transition-all">ëŒ€í™”ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”!</div>
            
            <div class="flex items-center justify-center gap-4">
                <button id="micBtn" onclick="toggleRecording()" class="w-20 h-20 bg-primary rounded-full flex items-center justify-center text-white text-3xl shadow-xl shadow-indigo-200 transition-all hover:bg-primaryDark active:scale-95">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
             <p class="text-center text-[10px] text-slate-300 mt-4">Powered by OpenAI GPT-4o & Whisper</p>
        </div>
    </div>

    <!-- 3. Report Interface -->
    <div id="reportInterface" class="hidden h-full overflow-y-auto bg-slate-50"></div>

    <!-- Logic -->
    <script>
        // =================================================================
        // [ì„¤ì •] ë°±ì—”ë“œ ì„œë²„ ëª¨ë“œ (Vercel ë°°í¬ìš©)
        // =================================================================
        const USE_BACKEND = true; 
        const BACKEND_URL = ''; // ë¹ˆì¹¸ì´ì–´ì•¼ ë°°í¬ëœ ì£¼ì†Œë¥¼ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
        // =================================================================

        let API_KEY = '';
        let messages = [];
        let recognition;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let audioContext;
        let analyser;
        let dataArray;
        let silenceStart;
        let isSpeaking = false;
        let silenceTimer;
        
        // --- 1. DYNAMIC TOPIC SELECTION ---
        const WARMUP_TOPICS = [
            "Self-introduction", "Favorite Food", "Favorite Color", "Animals/Pets", "Family members", 
            "School Life", "Hobbies", "Weekends", "Best Friend", "Weather", 
            "Favorite Movie", "Sports", "Music", "Travel", "Morning Routine", "Future Dream"
        ];
        
        function getSystemPrompt() {
            const randomTopic = WARMUP_TOPICS[Math.floor(Math.random() * WARMUP_TOPICS.length)];
            
            return `
You are "Tuit", a warm, clear, and supportive English speaking test guide for Korean elementary/middle school students. Voice: "Alloy".

âš ï¸ CRITICAL RULES:
1. NO MARKDOWN: Do not use bold(**), headers(###), lists(-) in conversational text.
2. ENGLISH ONLY: Speak strictly in English during the interview.
3. JSON OUTPUT: At the end, output evaluation result ONLY as a JSON code block.
4. **ONE QUESTION PER TURN**: Never ask multiple questions at once. Wait for the user's answer.
5. **SHORT & CLEAR**: Keep questions simple (10-15 words max) for young learners.

[Process Flow]
1. **Opening**: Warm greeting & **ask for their name** (e.g. "What's your name?").
2. **Warm-up (Q1-Q2)**:
   - **MANDATORY TOPIC:** Start the warm-up by asking about **${randomTopic}**.
   - **START SIMPLE (A1-A2 Level):** Begin with very easy questions.
   - Aim: Build confidence.
3. **Adaptive Interview (Q3-8)**:
   - Ask ONE question at a time based on previous performance.
   - React positively ("That sounds fun!", "Good job!") then ask next.
   - **Difficulty Adjustment:**
     - Short/broken answer -> Keep simple (A1/A2).
     - Fluent/detailed answer -> Increase complexity (B1+).
   - If Korean used: 1st time "Let's try English!", 2nd "Simple English is okay!", 3rd Accept but penalize.
4. **Closing**:
   - FIRST, say the trigger phrase: "Thank you so much for chatting with me today, [Name]! You did a great job. I now have enough information to evaluate your speaking level."
   - THEN, output the separator "|||REPORT|||"
   - FINALLY, output the JSON object.

[JSON Structure]
\`\`\`json
{
  "user_name": "...",
  "final_level_display": "e.g. A2 early (Elementary)",
  "final_level_code": "A1_early | A1_late | A2_early | A2_late | B1 | B2 | C1",
  "cefr_index": 0-6,
  "summary_text": "Korean summary...",
  "level_overview": { 
      "core_competency": "Text from table...", 
      "academic_level": "Text from table...", 
      "practical_skill": "Text from table..." 
  },
  "scores": { "fluency": 1-5, "accuracy": 1-5, "vocabulary": 1-5, "pronunciation": 1-5, "coherence": 1-5, "interaction": 1-5 },
  "feedback": { 
      "fluency": "Korean Feedback...", 
      "accuracy": "Korean Feedback...", 
      "vocabulary": "Korean Feedback...", 
      "pronunciation": "Korean Feedback...", 
      "coherence": "Korean Feedback...", 
      "interaction": "Korean Feedback..." 
  },
  "strengths": [ 
      { "area": "Area Name", "text": "Positive Korean Feedback", "example": "Student's English Quote" },
      { "area": "Area Name", "text": "Positive Korean Feedback", "example": "Student's English Quote" }
  ],
  "improvements": [ 
      { "area": "Area Name", "text": "Specific Korean Advice (Tip)", "example": "Wrong Sentence -> Right Sentence" }
  ],
  "recommendation": { "textbook_title": "...", "textbook_cover": "...", "reason": "Korean Reason..." }
}
\`\`\`

[Report Guidelines]
- **Tone:** Friendly and polite Korean ending with **"-ìš”"** (e.g., "ì •ë§ ì˜í–ˆì–´ìš”!", "ì—°ìŠµì´ í•„ìš”í•´ìš”."). Avoid formal "-ìŠµë‹ˆë‹¤".
- **Language:** All feedback text MUST be in **Korean**.
- **Strengths:** Identify 2 distinct strengths. **Use DIFFERENT example sentences for each strength to show variety.**
- **Improvements:** Identify 2 distinct areas for improvement. **Use DIFFERENT example sentences.** Remove priority markings.
  - **IMPORTANT:** For "improvements", the "text" field should be a specific **Tip** explaining the correction (e.g., "3ì¸ì¹­ ë‹¨ìˆ˜ì¼ ë•ŒëŠ” së¥¼ ë¶™ì—¬ì•¼ í•´ìš”"). The "example" field MUST follow "Student's Wrong Sentence -> Correct Sentence" format. **IMPORTANT: Wrap corrected parts in [brackets] for highlighting.**

[Level Overview Table (Strictly use these texts)]
Format: Level | Core Competency | Academic Level | Practical Skill
A1_early | ì˜ì–´ë¥¼ ë‹¨ì–´ ì¤‘ì‹¬ìœ¼ë¡œ í‘œí˜„í•˜ëŠ” ì…ë¬¸ ë‹¨ê³„ | ì´ˆë“±í•™êµ 3í•™ë…„ êµê³¼ì„œì˜ ê¸°ì´ˆ ë‹¨ì–´ì™€ í‘œí˜„ì„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”. | ì™¸êµ­ì¸ì—ê²Œ ì¸ì‚¬í•˜ê³ , ë‹¨ì–´Â·ì§§ì€ í‘œí˜„ìœ¼ë¡œ ê°ì •ì´ë‚˜ ìƒíƒœë¥¼ ë§í•  ìˆ˜ ìˆì–´ìš”.
A1_late | ì§§ì€ ë¬¸ì¥ì„ í™œìš©í•´ ê¸°ë³¸ì ì¸ ì˜ì‚¬ì†Œí†µì„ ì‹œì‘í•˜ëŠ” ê¸°ì´ˆ ë‹¨ê³„ | ì´ˆë“± 4~5í•™ë…„ ìˆ˜ì¤€ì˜ í•„ìˆ˜ í‘œí˜„ê³¼ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•  ìˆ˜ ìˆì–´ìš”. | ê°„ë‹¨í•œ ë¬¸ì¥ìœ¼ë¡œ ìê¸°ì†Œê°œì™€ ê¸°ë³¸ ì •ë³´ ì „ë‹¬ì´ ê°€ëŠ¥í•´ìš”.
A2_early | ì¼ìƒ ì† ê¸°ë³¸ ëŒ€í™”ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ì´ˆê¸‰ ë‹¨ê³„ | ì¤‘1 êµê³¼ì„œ ìˆ˜ì¤€ì˜ ë¬¸ë²•ê³¼ ì¼ìƒ ë¬¸ì¥ì„ í™œìš©í•´ ë§í•  ìˆ˜ ìˆì–´ìš”. | í•´ì™¸ì—¬í–‰ì—ì„œ ì£¼ë¬¸Â·ê¸¸ ë¬»ê¸° ë“± ê¸°ë³¸ ìƒí™©ì„ ìŠ¤ìŠ¤ë¡œ í•´ê²°í•  ìˆ˜ ìˆì–´ìš”.
A2_late | ìì‹ ì˜ ìƒê°ì„ í™•ì¥í•´ ë§í•˜ëŠ” ì„±ì¥ ë‹¨ê³„ | ì¤‘2~ì¤‘3 ìˆ˜ì¤€ìœ¼ë¡œ, ê¸´ ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°í•  ìˆ˜ ìˆì–´ìš”. | ìµìˆ™í•œ ì£¼ì œë¼ë©´ ì™¸êµ­ì¸ ì¹œêµ¬ì™€ ì˜ê²¬ì„ ì£¼ê³ ë°›ìœ¼ë©° ëŒ€í™”í•  ìˆ˜ ìˆì–´ìš”.
B1 | ì¼ìƒ ëŒ€í™”ë¥¼ ë§‰í˜ ì—†ì´ ì´ì–´ê°€ëŠ” ì¤‘ê¸‰ ë‹¨ê³„ | ê³ 1 ìˆ˜ì¤€ìœ¼ë¡œ, ì£¼ìš” ë¬¸ë²•ê³¼ í‘œí˜„ì„ ì•ˆì •ì ìœ¼ë¡œ ì‚¬ìš©í•´ìš”. | ë‹¤ì–‘í•œ ì£¼ì œë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•˜ë©° ë§í•˜ê¸°ì˜ ë‹µë‹µí•¨ì´ ê±°ì˜ ì—†ì–´ìš”.
B2 | ë…¼ë¦¬ì ìœ¼ë¡œ ìƒê°ì„ ì „ê°œí•˜ëŠ” ì‹¬í™” ë‹¨ê³„ | ìˆ˜ëŠ¥ 1ë“±ê¸‰ ìˆ˜ì¤€ì— í•´ë‹¹í•˜ë©°, ê³ ë‚œë„ ë¬¸ì¥ë„ ì´í•´í•˜ê³  ë§í•  ìˆ˜ ìˆì–´ìš”. | ì˜ì–´ ìˆ˜ì—…ì„ ë“£ê³  í† ë¡ ì´ ê°€ëŠ¥í•  ë§Œí¼ ì‚¬ê³ ë¥¼ ì˜ì–´ë¡œ í’€ì–´ë‚¼ ìˆ˜ ìˆì–´ìš”.
C1 | ì „ë¬¸ì  ì£¼ì œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë£¨ëŠ” ìµœìƒìœ„ ë‹¨ê³„ | ëŒ€í•™ ì „ê³µ ìˆ˜ì—…ì„ ì˜ì–´ë¡œ ë”°ë¼ê°ˆ ìˆ˜ ìˆì„ ë§Œí¼ ë†’ì€ ì–¸ì–´ ëŠ¥ë ¥ì´ì—ìš”. | í†µì—­ ë„ì›€ ì—†ì´ ì—…ë¬´Â·ì‹¬ì¸µ ëŒ€í™”Â·ì „ë¬¸ ì£¼ì œ í† ë¡ ì„ ëª¨ë‘ ì˜ì–´ë¡œ ìˆ˜í–‰í•  ìˆ˜ ìˆì–´ìš”.

[Textbook Mapping]
A1_early: Night Animals Adventure (https://drive.google.com/thumbnail?id=1MEhhsdi7ZsoXGKqTFaBeXo8ZMJboWfX5&sz=w1000)
A1_late: Why Do Flowers Grow? (https://drive.google.com/thumbnail?id=1y_i_9CkrTveMpliXHKCQJfOl2jn05M3s&sz=w1000)
A2_early: From Farm to Table (https://drive.google.com/thumbnail?id=1Y6tc0qvy2k0DEdNphzrgVTjDOT38C5r-&sz=w1000)
A2_late: Why Do We Get Hangry? (https://drive.google.com/thumbnail?id=108G8r5JR3skgcojkSGEsybEnvHesZwsu&sz=w1000)
B1: The Amazing History of Pizza (https://drive.google.com/thumbnail?id=10cok7aDzrwfhL-p8TiSmhZTGRhHQ_N1t&sz=w1000)
B2: What If the World Lost Oxygen (https://drive.google.com/thumbnail?id=1dcLtIVAcqpPU5pczGTeApA4EuLc90SQh&sz=w1000)
C1: How is Money Made (https://drive.google.com/thumbnail?id=1sHQCE4KshqhZd4WAMS3PUnbMEelXVlEf&sz=w1000)
`;
        }

        // --- 2. Initialization ---
        function initApp() {
            const controls = document.getElementById('setupControls');
            
            if (USE_BACKEND) {
                controls.innerHTML = `
                    <button onclick="startTest()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-4 rounded-xl hover:scale-[1.02] transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                        <span>ì‹œì‘í•˜ê¸°</span><i class="fas fa-arrow-right"></i>
                    </button>
                `;
                document.getElementById('setupFooter').style.display = 'none';
            } else {
                document.getElementById('setupFooter').style.display = 'block';
                controls.innerHTML = `
                    <input type="password" id="apiKeyInput" placeholder="OpenAI API Key (sk-...)" class="w-full bg-slate-50 border border-slate-300 rounded-xl p-4 focus:ring-4 focus:ring-primaryLight outline-none transition text-center font-mono text-sm">
                    <button onclick="startTest()" class="w-full bg-primary hover:bg-primaryDark text-white font-bold py-4 rounded-xl hover:scale-[1.02] transition shadow-lg transform active:scale-95 flex items-center justify-center gap-2">
                        <span>ì‹œì‘í•˜ê¸°</span><i class="fas fa-arrow-right"></i>
                    </button>
                `;
            }
        }
        
        function startTest() {
            if (!USE_BACKEND) {
                const key = document.getElementById('apiKeyInput').value.trim();
                if(!key.startsWith('sk-')) { alert('ìœ íš¨í•œ API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                API_KEY = key;
            }
            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            setupAudioRecording();
            messages = [{ role: "system", content: getSystemPrompt() }];
            processAI(); 
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // --- 3. Audio Recording & Whisper Logic ---
        function setupAudioRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // Silence Detection
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    
                    analyser.fftSize = 512;
                    const bufferLength = analyser.frequencyBinCount;
                    dataArray = new Uint8Array(bufferLength);

                    // MediaRecorder
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        updateMicUI(false);
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        audioChunks = [];
                        
                        // Process Audio
                        if (audioBlob.size > 2000) { 
                            document.getElementById('statusText').innerText = "ìƒê° ì¤‘ì´ì—ìš”...";
                            if (USE_BACKEND) await sendAudioToBackend(audioBlob);
                            else await sendAudioToWhisper(audioBlob);
                        } else {
                             document.getElementById('statusText').innerText = "ëª©ì†Œë¦¬ê°€ ë„ˆë¬´ ì‘ì•„ìš”. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.";
                        }
                    };

                    // Start Silence Detection Loop
                    detectSilence();
                })
                .catch(err => {
                    console.error("Mic Error:", err);
                    alert("ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
        }

        function detectSilence() {
            if (!isRecording) {
                requestAnimationFrame(detectSilence);
                return;
            }
            
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let average = sum / dataArray.length;

            // Threshold for speech (Adjustable)
            if (average > 15) { // Speaking
                silenceStart = Date.now();
                isSpeaking = true;
                document.getElementById('statusText').className = "text-center text-xs font-bold text-primary mb-4 h-4 animate-pulse";
            } else {
                // Silence (1.2s Threshold)
                if (isSpeaking && Date.now() - silenceStart > 1200) {
                    toggleRecording(); // Stop recording automatically
                    isSpeaking = false;
                }
            }
            requestAnimationFrame(detectSilence);
        }

        function toggleRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Start
                isRecording = true;
                audioChunks = [];
                mediaRecorder.start();
                updateMicUI(true);
                document.getElementById('statusText').innerText = "ë“£ê³  ìˆì–´ìš”.";
                silenceStart = Date.now();
                isSpeaking = false;
            } else {
                // Stop
                isRecording = false;
                mediaRecorder.stop(); 
            }
        }

        // --- CLIENT SIDE WHISPER (Demo) ---
        async function sendAudioToWhisper(blob) {
            const formData = new FormData();
            formData.append("file", blob, "recording.webm");
            formData.append("model", "whisper-1");

            try {
                const response = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${API_KEY}` },
                    body: formData
                });

                if (!response.ok) throw new Error("Whisper API Error");

                const data = await response.json();
                handleUserText(data.text);
            } catch (e) {
                console.error(e);
                document.getElementById('statusText').innerText = "ìŒì„± ì¸ì‹ ì˜¤ë¥˜.";
            }
        }

        // --- SERVER SIDE WHISPER (Backend) ---
        async function sendAudioToBackend(blob) {
            const formData = new FormData();
            formData.append("file", blob, "recording.webm");

            try {
                const response = await fetch(`${BACKEND_URL}/api/whisper`, {
                    method: "POST",
                    body: formData
                });
                if (!response.ok) throw new Error("Backend Whisper Error");
                const data = await response.json();
                handleUserText(data.text);
            } catch (e) {
                console.error(e);
                document.getElementById('statusText').innerText = "ì„œë²„ ì˜¤ë¥˜.";
            }
        }

        function handleUserText(text) {
            if (text && text.trim()) {
                addMessage('user', text);
                messages.push({ role: "user", content: text });
                processAI();
            } else {
                document.getElementById('statusText').innerText = "ì†Œë¦¬ë¥¼ ë“£ì§€ ëª»í–ˆì–´ìš”.";
            }
        }

        function updateMicUI(active) {
            const btn = document.getElementById('micBtn');
            if(active) {
                btn.classList.add('pulse-ring', 'bg-red-500');
                btn.classList.remove('bg-primary');
                btn.innerHTML = '<i class="fas fa-stop"></i>';
            } else {
                btn.classList.remove('pulse-ring', 'bg-red-500');
                btn.classList.add('bg-primary');
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        // --- 4. AI Processing ---
        async function processAI() {
            showTyping(true);
            
            try {
                // ADD model params for Backend
                const requestBody = {
                    model: "gpt-4o",
                    messages: messages,
                    temperature: 0.7
                };

                let data;
                if (USE_BACKEND) {
                    const response = await fetch(`${BACKEND_URL}/api/chat`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) throw new Error("Backend Chat Error");
                    data = await response.json();
                } else {
                    const response = await fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify(requestBody)
                    });
                    data = await response.json();
                }

                const aiText = data.choices[0].message.content;
                messages.push({ role: "assistant", content: aiText });
                showTyping(false);

                if (aiText.includes("|||REPORT|||") || aiText.includes("```json")) {
                    let closingText = "";
                    let jsonPart = aiText;

                    if (aiText.includes("|||REPORT|||")) {
                        const parts = aiText.split("|||REPORT|||");
                        closingText = parts[0].trim();
                        jsonPart = parts[1].trim();
                    } else {
                        const jsonStart = aiText.indexOf("```json");
                        if (jsonStart > 0) {
                            closingText = aiText.substring(0, jsonStart).trim();
                            jsonPart = aiText.substring(jsonStart).trim();
                        }
                    }

                    if (closingText) {
                        addMessage('ai', closingText);
                        await playTTS(closingText);
                    }

                    try {
                        let jsonStr = jsonPart;
                        if (jsonStr.includes("```json")) {
                            jsonStr = jsonStr.split("```json")[1];
                            if (jsonStr.includes("```")) {
                                jsonStr = jsonStr.split("```")[0];
                            }
                        }
                        
                        const start = jsonStr.indexOf('{');
                        const end = jsonStr.lastIndexOf('}');
                        if (start !== -1 && end !== -1) {
                            jsonStr = jsonStr.substring(start, end + 1);
                        }

                        const reportData = JSON.parse(jsonStr);
                        renderReport(reportData);
                    } catch (e) {
                        console.error("JSON Parse Error", e);
                        alert("ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }

                } else {
                    addMessage('ai', aiText);
                    playTTS(aiText); 
                    document.getElementById('statusText').innerText = "ëŒ€í™”ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”!";
                }

            } catch (error) {
                console.error(error);
                showTyping(false);
                alert("ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (server.js ì‹¤í–‰ í™•ì¸)");
            }
        }

        async function playTTS(text) {
            const lastMsg = document.querySelector('#messages').lastElementChild;
            const icon = lastMsg ? lastMsg.querySelector('.ai-icon') : null;
            if(icon) icon.classList.add('animate-pulse');

            try {
                const ttsBody = { model: "tts-1", input: text, voice: "alloy", speed: 0.85 }; // âœ… Speed 0.85 Checked!
                let blob;
                
                if (USE_BACKEND) {
                    const response = await fetch(`${BACKEND_URL}/api/tts`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(ttsBody)
                    });
                    if (!response.ok) throw new Error("Backend TTS Error");
                    blob = await response.blob();
                } else {
                    const response = await fetch("https://api.openai.com/v1/audio/speech", {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                        body: JSON.stringify(ttsBody)
                    });
                    blob = await response.blob();
                }
                
                const audio = new Audio(URL.createObjectURL(blob));
                
                return new Promise((resolve) => {
                    audio.onended = () => {
                        if(icon) icon.classList.remove('animate-pulse');
                        resolve();
                    };
                    audio.onerror = () => {
                        if(icon) icon.classList.remove('animate-pulse');
                        resolve();
                    };
                    audio.play();
                });
            } catch (e) {
                if(icon) icon.classList.remove('animate-pulse');
            }
        }

        // --- 5. UI Helpers ---
        function addMessage(role, text) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} fade-in`;
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] p-4 rounded-2xl text-base leading-relaxed shadow-sm ${role === 'user' ? 'bg-primary text-white rounded-tr-none' : 'bg-white text-slate-700 border border-slate-200 rounded-tl-none'}`;
            bubble.innerText = text;
            if(role === 'ai') {
                const icon = document.createElement('div');
                icon.className = "ai-icon w-8 h-8 bg-primaryLight text-primary rounded-full flex-shrink-0 flex items-center justify-center mr-2 text-sm";
                icon.innerHTML = "ğŸ¤–";
                div.appendChild(icon);
            }
            div.appendChild(bubble);
            container.appendChild(div);
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
        }

        function showTyping(show) {
            const existing = document.getElementById('typingIndicator');
            if (existing) existing.remove();
            if (show) {
                const container = document.getElementById('messages');
                const div = document.createElement('div');
                div.id = 'typingIndicator';
                div.className = 'flex justify-start fade-in';
                div.innerHTML = `<div class="w-8 h-8 bg-primaryLight text-primary rounded-full flex-shrink-0 flex items-center justify-center mr-2 text-sm">ğŸ¤–</div><div class="bg-white p-4 rounded-2xl rounded-tl-none border border-slate-200 shadow-sm flex gap-1"><div class="w-2 h-2 bg-primary rounded-full typing-dot"></div><div class="w-2 h-2 bg-primary rounded-full typing-dot"></div><div class="w-2 h-2 bg-primary rounded-full typing-dot"></div></div>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }
        }

        function endTestEarly() {
            if(confirm("í‰ê°€ë¥¼ ì¢…ë£Œí•˜ê³  ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í• ê¹Œìš”?")) {
                messages.push({ role: "system", content: "User requested early finish. Proceed to closing." });
                processAI();
            }
        }

        // --- 6. Render Report ---
        function renderReport(data) {
            document.getElementById('chatInterface').classList.add('hidden');
            const reportDiv = document.getElementById('reportInterface');
            reportDiv.classList.remove('hidden');

            const percent = Math.max((data.cefr_index / 6) * 100, 10);
            
            // 6 Skills Mapping (Titles Updated)
            const skillMap = { 
                fluency: 'Fluency (ìœ ì°½ì„±)', 
                accuracy: 'Accuracy (ì •í™•ì„±)', 
                vocabulary: 'Vocabulary (ì–´íœ˜ ë‹¤ì–‘ì„±)', 
                pronunciation: 'Pronunciation (ë°œìŒ)', 
                coherence: 'Coherence (ë…¼ë¦¬&ì—°ê²°ì„±)', 
                interaction: 'Interaction (ìƒí˜¸ì‘ìš©)' 
            };
            const skillsHTML = Object.keys(data.scores).map(k => 
                `<div class="mb-3"><div class="flex justify-between text-xs font-bold text-slate-500 mb-1"><span>${skillMap[k]}</span> <span class="text-primary">${data.scores[k]}/5</span></div><div class="gauge-bg mb-1"><div class="gauge-bar bg-primary" style="width: ${data.scores[k]*20}%"></div></div><p class="text-xs text-slate-400">${data.feedback[k]}</p></div>`
            ).join('');

            // Strengths
            const strList = data.strengths.map(i => `
                <div class="bg-white p-4 rounded-xl border border-green-200 shadow-sm mb-3 relative overflow-hidden">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center text-green-600 text-xs"><i class="fas fa-thumbs-up"></i></span>
                        <span class="font-bold text-sm text-slate-700">ì°¸ ì˜í–ˆì–´ìš”! - ${i.area}</span>
                    </div>
                    <p class="text-sm text-slate-600 mb-3 leading-relaxed">${i.text}</p>
                    ${i.example ? `
                    <div class="mt-2 bg-green-50 p-3 rounded-xl border border-green-100 relative group">
                        <div class="flex items-center gap-1.5 mb-1">
                            <span class="w-5 h-5 rounded-full bg-green-200 flex items-center justify-center text-green-700 text-[10px]"><i class="fas fa-microphone"></i></span>
                            <span class="text-[10px] font-bold text-green-700 uppercase tracking-wide">My Best Sentence</span>
                        </div>
                        <p class="text-green-900 text-sm font-semibold pl-1">"${i.example}"</p>
                        <div class="absolute top-2 right-2 text-green-200 opacity-50"><i class="fas fa-quote-right text-xl"></i></div>
                    </div>` : ''}
                </div>
            `).join('');

            // Improvements
            const impList = data.improvements.map(i => {
                let exampleHTML = '';
                if (i.example && i.example.includes('->')) {
                    let [wrong, right] = i.example.split('->').map(s => s.trim());
                    
                    // Apply Highlights based on [brackets]
                    wrong = wrong.replace(/\[(.*?)\]/g, '<span class="text-red-600 font-bold">$1</span>');
                    right = right.replace(/\[(.*?)\]/g, '<span class="text-blue-600 font-bold">$1</span>');

                    exampleHTML = `
                    <div class="mt-3 bg-slate-50 rounded-xl border border-slate-200 p-4">
                        <!-- Wrong Row -->
                        <div class="flex flex-col mb-3 pb-3 border-b border-slate-200 border-dashed">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-5 h-5 rounded-full bg-red-100 flex items-center justify-center text-red-500 text-[10px]"><i class="fas fa-times"></i></span>
                                <span class="text-xs font-bold text-slate-500">ì´ë ‡ê²Œ ë§í–ˆì–´ìš”</span>
                            </div>
                            <p class="text-sm text-red-600 font-medium pl-7 break-words">"${wrong}"</p>
                        </div>
                        <!-- Right Row -->
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 text-[10px]"><i class="fas fa-check"></i></span>
                                <span class="text-xs font-bold text-slate-900">ì›ì–´ë¯¼ì€ ì–´ë–»ê²Œ ë§í• ê¹Œìš”?</span>
                            </div>
                            <p class="text-sm text-slate-900 font-bold pl-7 break-words">"${right}"</p>
                        </div>
                    </div>
                    <!-- Tip -->
                    <div class="mt-2 bg-yellow-50 p-3 rounded-lg border border-yellow-100 flex items-start gap-2">
                        <span class="text-yellow-500 text-sm mt-0.5"><i class="fas fa-lightbulb"></i></span>
                        <p class="text-xs text-slate-600 leading-relaxed"><span class="font-bold text-yellow-600">Tip:</span> ${i.text}</p>
                    </div>`;
                }
                return `
                <div class="bg-white p-4 rounded-xl border border-orange-100 shadow-sm mb-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-6 h-6 rounded-full bg-orange-100 flex items-center justify-center text-orange-600 text-xs"><i class="fas fa-wrench"></i></span>
                        <span class="font-bold text-sm text-slate-700">${i.area}</span>
                    </div>
                    ${exampleHTML || `<p class="text-sm text-slate-600 mb-3 leading-relaxed">${i.text}</p>`}
                </div>
            `}).join('');

            const lo = data.level_overview || { core_competency: "-", academic_level: "-", practical_skill: "-" };

            reportDiv.innerHTML = `
                <div class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl relative pb-10">
                    <!-- Hero Section -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-8 pb-12 rounded-b-[2.5rem] relative overflow-hidden">
                         <div class="relative z-10 text-center">
                            <div class="w-24 h-24 bg-yellow-400 rounded-full mx-auto flex items-center justify-center shadow-lg border-4 border-yellow-200 mb-4 animate-bounce"><i class="fas fa-trophy text-4xl text-yellow-900"></i></div>
                            <h2 class="text-lg opacity-90 mb-1 font-medium"><span class="font-black text-yellow-100 text-xl">${data.user_name}</span> ë‹˜ì˜ ë ˆë²¨</h2>
                            <h1 class="text-3xl font-black mb-4 drop-shadow-md tracking-tight">${data.final_level_display}</h1>
                            <p class="text-sm bg-white/10 p-4 rounded-2xl leading-relaxed backdrop-blur-sm border border-white/10 shadow-inner">${data.summary_text}</p>
                         </div>
                         <div class="mt-8 relative z-10">
                            <div class="flex justify-between text-[10px] font-bold opacity-80 mb-1 px-1"><span>A1</span><span>A2</span><span>B1</span><span>B2</span><span>C1</span></div>
                            <div class="h-3 w-full bg-black/20 rounded-full overflow-hidden relative">
                                <div class="absolute w-full h-full flex divide-x divide-white/10"><div class="flex-1"></div><div class="flex-1"></div><div class="flex-1"></div><div class="flex-1"></div><div class="flex-1"></div></div>
                                <div class="h-full bg-gradient-to-r from-yellow-300 to-orange-400 rounded-full relative shadow" style="width: ${percent}%"></div>
                            </div>
                         </div>
                    </div>

                    <div class="px-5 space-y-6 -mt-6 relative z-20">
                        <!-- Level Overview -->
                        <div class="bg-white p-5 rounded-2xl shadow-lg border border-primaryLight">
                             <h3 class="text-primaryDark font-bold mb-4 flex items-center text-sm uppercase tracking-wider"><span class="text-2xl mr-2">ğŸ“Š</span> Level Overview</h3>
                             <div class="grid grid-cols-1 gap-3">
                                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100"><div class="text-[10px] font-bold text-indigo-400 uppercase mb-1">Core Competency</div><div class="flex items-start"><span class="mr-2 text-lg">ğŸŒ±</span><p class="text-sm text-slate-700 font-bold leading-snug">${lo.core_competency}</p></div></div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Academic Level</div><div class="flex items-start"><span class="mr-2 text-lg">ğŸ«</span><p class="text-sm text-slate-600 font-medium leading-snug">${lo.academic_level}</p></div></div>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><div class="text-[10px] font-bold text-slate-400 uppercase mb-1">Practical Skill</div><div class="flex items-start"><span class="mr-2 text-lg">ğŸ’¬</span><p class="text-sm text-slate-600 font-medium leading-snug">${lo.practical_skill}</p></div></div>
                             </div>
                        </div>

                        <!-- Skills -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-50">
                            <h3 class="text-lg font-bold text-slate-800 mb-5 flex items-center"><i class="fas fa-chart-pie mr-2 text-primary"></i> ìŠ¤í”¼í‚¹ í•µì‹¬ ì—­ëŸ‰</h3>
                            ${skillsHTML}
                        </div>

                        <!-- Strengths -->
                        <div class="bg-green-50 p-5 rounded-2xl border border-green-100">
                            <h3 class="text-green-700 font-bold mb-4 flex items-center"><i class="fas fa-thumbs-up mr-2"></i> ê°•ì  (Strengths)</h3>
                            ${strList}
                        </div>

                        <!-- Improvements -->
                        <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100">
                            <h3 class="text-orange-700 font-bold mb-4 flex items-center"><i class="fas fa-lightbulb mr-2"></i> ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆì–´ìš”!</h3>
                            ${impList}
                        </div>

                        <!-- Recommendation -->
                        <div class="bg-slate-800 text-white p-6 rounded-2xl shadow-2xl text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-yellow-400 to-pink-500"></div>
                            <h3 class="text-sm font-bold mb-1 text-slate-400 uppercase tracking-widest">ì¶”ì²œ ìˆ˜ì—… ë ˆë²¨</h3>
                            <div class="text-2xl font-black text-yellow-300 mb-5">${data.final_level_display}</div>
                            
                            <div class="bg-white/10 p-6 rounded-2xl mb-6 backdrop-blur-md border border-white/10">
                                <div class="text-center mb-4"><span class="inline-block py-1 px-3 rounded-full bg-white/20 text-yellow-100 text-xs font-bold uppercase tracking-wider">ğŸ“š ì¶”ì²œ ìˆ˜ì—… êµì¬</span></div>
                                <div class="aspect-video w-full mx-auto mb-4 bg-slate-800/50 rounded-xl overflow-hidden shadow-2xl border border-white/10 flex items-center justify-center"><img src="${data.recommendation.textbook_cover}" class="h-full w-auto object-contain"></div>
                                <h4 class="text-xl font-bold text-white mb-2 text-center">${data.recommendation.textbook_title}</h4>
                                <p class="text-sm leading-relaxed opacity-90 font-medium text-slate-100">${data.recommendation.reason}</p>
                            </div>
                            <button onclick="window.open('https://www.tuit.co.kr/lesson', '_blank')" class="w-full bg-yellow-400 hover:bg-yellow-300 text-slate-900 font-black py-4 rounded-xl text-lg flex items-center justify-center gap-2 shadow-[0_4px_0_rgb(202,138,4)] active:shadow-none active:translate-y-1 transition-all"><span>ë¬´ë£Œ ì²´í—˜ ìˆ˜ì—… ì˜ˆì•½í•˜ê¸°</span><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => { document.querySelectorAll('.gauge-bar').forEach(el => {}); }, 100);
        }
    </script>
</body>
</html>